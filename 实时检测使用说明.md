# 实时入侵检测系统使用说明

## 文件说明

`realtime_ids.py` - 实时入侵检测系统主程序

**功能特点：**
- ✅ 强制CPU推理（即使有GPU也会使用CPU）
- ✅ 支持stdin和tail-file两种输入模式
- ✅ 实时统计QPS、延迟、告警计数
- ✅ 专业日志输出
- ✅ 支持JSONL和CSV输出格式
- ✅ 健康检查和干运行模式

---

## 快速开始

### 1. 健康检查

首先检查模型是否正常加载：

```bash
python realtime_ids.py --health-check --model-path ckpt/model.pth
```

**输出示例：**
```
================================================================================
实时入侵检测系统 - 健康检查
================================================================================
版本: 1.0.0 (hash: 5d41402a)
模型路径: ckpt/model.pth
模型哈希: a1b2c3d4e5f6g7h8
输入维度: 33
输出类别数: 5
运行设备: cpu
PyTorch版本: 2.0.0
================================================================================

✓ 模型加载成功，系统就绪
```

---

## 使用示例

### 示例1：从stdin读取（管道输入）

**场景：** 通过管道从CSV文件读取数据并实时检测

```bash
# 读取CSV文件并通过管道输入
cat data/KDDTest+.csv | python realtime_ids.py --stdin --model-path ckpt/model.pth

# 或者使用head命令测试少量数据
head -n 100 data/KDDTest+.csv | python realtime_ids.py --stdin --model-path ckpt/model.pth
```

**输出：** 检测结果会实时输出到stdout（JSONL格式）

**示例输出：**
```json
{"timestamp": "2024-01-15T10:30:45.123456", "src": "NA", "threat_type": "正常", "threat_label": 0, "confidence": 0.98, "latency_ms": 0.85, "model_version": "a1b2c3d4e5f6g7h8"}
{"timestamp": "2024-01-15T10:30:45.234567", "src": "NA", "threat_type": "DoS攻击", "threat_label": 1, "confidence": 0.95, "latency_ms": 0.92, "model_version": "a1b2c3d4e5f6g7h8"}
```

**统计信息（每10秒输出一次）：**
```
2024-01-15 10:30:55 [INFO] ================================================================================
2024-01-15 10:30:55 [INFO] 统计报告 [总检测: 1000, 告警: 125]
2024-01-15 10:30:55 [INFO] QPS: 100.25 | 延迟: 均值=0.89ms, P50=0.85ms, P95=1.23ms, P99=1.56ms
2024-01-15 10:30:55 [INFO] 告警分类:
2024-01-15 10:30:55 [INFO]   DoS攻击: 100
2024-01-15 10:30:55 [INFO]   探测攻击: 25
2024-01-15 10:30:55 [INFO] ================================================================================
```

---

### 示例2：监听文件追加（tail-file模式）

**场景：** 持续监听日志文件的新增内容，模拟实时流量检测

```bash
# 创建测试日志文件（如果还没有）
touch /tmp/network_traffic.log

# 启动实时检测（在后台运行）
python realtime_ids.py --tail-file /tmp/network_traffic.log --model-path ckpt/model.pth --output results.jsonl --log-level INFO

# 在另一个终端追加数据（模拟实时日志）
tail -n 100 data/KDDTest+.csv >> /tmp/network_traffic.log
```

**特点：**
- 只读取文件新增的内容（类似`tail -f`）
- 适合监听持续追加的日志文件
- 支持优雅退出（Ctrl+C会输出最终统计）

**输出文件格式（results.jsonl）：**
每行一个JSON对象，包含检测结果

---

### 示例3：指定输出文件和格式

**场景：** 将检测结果保存为CSV格式文件

```bash
# 使用stdin输入，输出到CSV文件
cat data/KDDTest+.csv | python realtime_ids.py \
    --stdin \
    --model-path ckpt/model.pth \
    --output results.csv \
    --output-format csv \
    --stats-interval 5.0
```

**CSV输出格式：**
```csv
2024-01-15T10:30:45.123456,NA,正常,0.9800,0.85
2024-01-15T10:30:45.234567,NA,DoS攻击,0.9500,0.92
```

**字段说明：**
- timestamp: 检测时间戳
- src: 源IP（NA表示未识别）
- threat_type: 威胁类型（正常/DoS攻击/U2R攻击/R2L攻击/探测攻击）
- confidence: 置信度（0-1）
- latency_ms: 检测延迟（毫秒）

---

## 高级用法

### 干运行模式（排查输入格式问题）

```bash
# 只解析输入，不执行推理（用于调试）
head -n 10 data/KDDTest+.csv | python realtime_ids.py \
    --stdin \
    --model-path ckpt/model.pth \
    --dry-run \
    --log-level DEBUG
```

**输出：**
```
2024-01-15 10:30:45 [INFO] [DRY-RUN] 解析成功: 41列, 源: NA
2024-01-15 10:30:45 [INFO] [DRY-RUN] 解析成功: 42列, 源: NA
```

---

### 自定义输入格式

```bash
# 明确指定输入格式（如果自动检测失败）
python realtime_ids.py \
    --stdin \
    --model-path ckpt/model.pth \
    --format csv42  # 或 csv41, csv43
```

**格式说明：**
- `auto`: 自动检测（默认，推荐）
- `csv41`: 41列（不含标签）
- `csv42`: 42列（含threat_type）
- `csv43`: 43列（含threat_type和difficulty）

---

### 调整统计报告间隔

```bash
# 每5秒输出一次统计（默认10秒）
python realtime_ids.py \
    --stdin \
    --model-path ckpt/model.pth \
    --stats-interval 5.0
```

---

### 调试模式（详细日志）

```bash
# 输出DEBUG级别日志
python realtime_ids.py \
    --stdin \
    --model-path ckpt/model.pth \
    --log-level DEBUG
```

---

## 命令行参数完整列表

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--stdin` | flag | - | 从标准输入读取 |
| `--tail-file PATH` | str | - | 监听文件追加（与--stdin二选一） |
| `--model-path` | str | `ckpt/model.pth` | 模型文件路径 |
| `--batch-size` | int | `1` | 批处理大小（实时场景建议1） |
| `--format` | str | `auto` | 输入格式（auto/csv41/csv42/csv43） |
| `--output` | str | `None` | 输出文件路径（默认stdout） |
| `--output-format` | str | `jsonl` | 输出格式（jsonl/csv） |
| `--log-level` | str | `INFO` | 日志级别（DEBUG/INFO/WARNING/ERROR） |
| `--stats-interval` | float | `10.0` | 统计报告间隔（秒） |
| `--dry-run` | flag | - | 干运行模式（只解析不推理） |
| `--health-check` | flag | - | 健康检查模式 |

---

## 输出说明

### JSONL格式（默认）

每行一个JSON对象：
```json
{
  "timestamp": "ISO8601时间戳",
  "src": "源IP或NA",
  "threat_type": "威胁类型名称",
  "threat_label": 0-6的数字标签,
  "confidence": 0.0-1.0的置信度,
  "latency_ms": 检测延迟（毫秒）,
  "model_version": "模型哈希"
}
```

### CSV格式

逗号分隔，字段顺序：
```
timestamp,src,threat_type,confidence,latency_ms
```

---

## 告警说明

当检测到攻击流量时：
1. **正常输出**：结果写入输出（stdout或文件）
2. **告警日志**：在stderr输出警告信息（带🚨标记）

**告警日志示例：**
```
2024-01-15 10:30:45 [WARNING] 🚨 告警: DoS攻击 (置信度: 95.00%, 延迟: 0.92ms, 源: NA)
```

---

## 性能指标

### 统计报告包含：

- **QPS**: 每秒处理的样本数
- **延迟指标**: 均值、P50、P95、P99
- **告警计数**: 总告警数和按类别分类统计
- **运行时长**: 系统运行时间

### 典型性能（CPU推理）：

- **单样本延迟**: < 1ms
- **吞吐量**: > 1000 samples/sec（单线程）
- **内存占用**: < 50MB（模型+运行时）

---

## 注意事项

1. **输入格式要求**：
   - 必须是逗号分隔的CSV格式
   - 列数必须是41、42或43列（会自动处理）
   - 每行一个样本

2. **模型要求**：
   - 必须使用 `kdd_federated_learning.py` 训练并保存的模型
   - 模型文件需包含 `max_values` 等预处理参数

3. **优雅退出**：
   - 按 `Ctrl+C` 会输出最终统计报告后退出
   - `tail-file` 模式退出时会关闭文件句柄

4. **CPU强制模式**：
   - 系统会强制使用CPU，即使机器有GPU
   - 适合生产环境无GPU的服务器

---

## 故障排查

### 问题1：模型加载失败

```
错误: 模型文件不存在: ckpt/model.pth
```

**解决：** 确保模型文件存在，或使用 `--model-path` 指定正确路径

### 问题2：输入格式不匹配

```
[WARNING] 无法自动识别格式: 40列，期望41/42/43列
```

**解决：** 
- 检查输入数据列数
- 使用 `--format` 明确指定格式
- 使用 `--dry-run` 模式排查

### 问题3：预处理失败

```
[ERROR] 预处理失败: ...
```

**解决：**
- 检查输入数据是否包含非数值列
- 使用 `--log-level DEBUG` 查看详细错误信息
- 确保输入格式与训练数据一致

---

## 集成示例

### 作为系统服务

创建systemd服务文件 `/etc/systemd/system/realtime-ids.service`:

```ini
[Unit]
Description=Real-time Intrusion Detection System
After=network.target

[Service]
Type=simple
User=ids
WorkingDirectory=/opt/ids
ExecStart=/usr/bin/python3 /opt/ids/realtime_ids.py \
    --tail-file /var/log/network/traffic.log \
    --model-path /opt/ids/ckpt/model.pth \
    --output /var/log/ids/results.jsonl \
    --stats-interval 30.0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 与日志收集系统集成

```bash
# 从syslog读取并实时检测
tail -f /var/log/syslog | grep "network" | \
    python realtime_ids.py --stdin --model-path ckpt/model.pth
```

---

## 开发说明

### 代码结构

- `InferenceEngine`: 模型加载和推理
- `InputReader`: 输入数据读取（stdin/tail-file）
- `OutputWriter`: 结果输出（stdout/file）
- `StatisticsCollector`: 性能统计收集

### 关键设计

1. **强制CPU模式**: `DEVICE = torch.device("cpu")`
2. **复用原模块**: 导入 `kdd_federated_learning` 复用预处理函数
3. **非阻塞读取**: 支持实时流式处理
4. **优雅退出**: 信号处理确保统计完整输出

---

## 许可证

与主项目保持一致

