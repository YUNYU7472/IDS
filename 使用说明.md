# 网络入侵检测系统使用说明

本项目支持**训练模式**和**检测模式**，可通过命令行参数选择。

## 目录结构

```
IDS/
├── kdd_federated_learning.py  # 主程序
├── check_gpu.py               # GPU检查工具
├── data/                      # 数据目录
│   ├── KDDTrain+.csv         # 训练数据
│   └── KDDTest+.csv          # 测试数据
└── 使用说明.md               # 本文件
```

---

## 一、训练模式

训练模式用于训练联邦学习模型并保存模型文件。

### 基本命令

```bash
python kdd_federated_learning.py --mode train --data_path data --model_path model.pth
```

### 完整参数说明

| 参数 | 说明 | 默认值 | 必填 |
|------|------|--------|------|
| `--mode` | 运行模式，设置为 `train` | - | ✅ 是 |
| `--data_path` | 数据目录路径（包含KDDTrain+.csv和KDDTest+.csv） | `data` | ❌ 否 |
| `--model_path` | 训练后保存的模型文件路径 | `model.pth` | ❌ 否 |
| `--epochs` | 每个节点的训练轮数 | `20` | ❌ 否 |
| `--batch_size` | 批次大小 | `32` | ❌ 否 |
| `--learning_rate` | 学习率 | `0.01` | ❌ 否 |
| `--momentum` | 动量参数 | `0.9` | ❌ 否 |
| `--slices` | 联邦学习节点数量 | `2` | ❌ 否 |
| `--iterations` | 联邦学习迭代次数 | `5` | ❌ 否 |
| `--smote` | 使用SMOTE进行数据平衡 | `False` | ❌ 否 |

### 训练模式示例

#### 1. 使用默认参数训练
```bash
python kdd_federated_learning.py --mode train
```

#### 2. 自定义模型保存路径
```bash
python kdd_federated_learning.py --mode train --model_path models/my_model.pth
```

#### 3. 自定义数据路径
```bash
python kdd_federated_learning.py --mode train --data_path ../datasets/nsl-kdd --model_path model.pth
```

#### 4. 调整训练参数
```bash
python kdd_federated_learning.py --mode train \
    --epochs 30 \
    --batch_size 64 \
    --learning_rate 0.001 \
    --slices 3 \
    --iterations 10 \
    --model_path model_v2.pth
```

#### 5. 使用SMOTE数据平衡
```bash
python kdd_federated_learning.py --mode train --smote --model_path model_smote.pth
```

#### 6. 完整参数示例
```bash
python kdd_federated_learning.py --mode train \
    --data_path data \
    --model_path models/federated_model.pth \
    --epochs 25 \
    --batch_size 32 \
    --learning_rate 0.01 \
    --momentum 0.9 \
    --slices 2 \
    --iterations 5 \
    --smote
```

---

## 二、检测模式

检测模式用于加载已训练的模型，对新数据进行入侵检测。

### 基本命令

```bash
python kdd_federated_learning.py --mode detect --model_path model.pth --data_path test_data.csv
```

### 完整参数说明

| 参数 | 说明 | 默认值 | 必填 |
|------|------|--------|------|
| `--mode` | 运行模式，设置为 `detect` | - | ✅ 是 |
| `--model_path` | 要加载的模型文件路径 | `model.pth` | ✅ 是 |
| `--data_path` | 要检测的CSV数据文件路径 | - | ✅ 是 |
| `--output_path` | 检测结果输出路径 | 自动生成 | ❌ 否 |

### 检测模式示例

#### 1. 基本检测（使用默认输出路径）
```bash
python kdd_federated_learning.py --mode detect \
    --model_path model.pth \
    --data_path test_data.csv
```
结果将自动保存为 `test_data_检测结果.csv`

#### 2. 指定输出路径
```bash
python kdd_federated_learning.py --mode detect \
    --model_path model.pth \
    --data_path test_data.csv \
    --output_path results/detection_results.csv
```

#### 3. 检测测试集
```bash
python kdd_federated_learning.py --mode detect \
    --model_path model.pth \
    --data_path data/KDDTest+.csv \
    --output_path test_results.csv
```

#### 4. 检测自定义数据
```bash
python kdd_federated_learning.py --mode detect \
    --model_path models/my_model.pth \
    --data_path my_network_traffic.csv \
    --output_path my_detection_results.csv
```

---

## 三、其他工具

### 检查GPU配置

```bash
python check_gpu.py
```

这会显示：
- PyTorch版本
- CUDA是否可用
- GPU名称和内存信息
- 设备配置

---

## 四、完整工作流程示例

### 步骤1：检查GPU（可选）
```bash
python check_gpu.py
```

### 步骤2：训练模型
```bash
python kdd_federated_learning.py --mode train \
    --data_path data \
    --model_path model.pth \
    --epochs 20 \
    --slices 2 \
    --iterations 5
```

### 步骤3：使用模型进行检测
```bash
python kdd_federated_learning.py --mode detect \
    --model_path model.pth \
    --data_path data/KDDTest+.csv \
    --output_path detection_results.csv
```

---

## 五、数据格式要求

### 训练数据格式

训练数据需要包含以下CSV文件：
- `KDDTrain+.csv` - 训练集
- `KDDTest+.csv` - 测试集

数据应包含41个特征列（最后一列是威胁类型标签）。

### 检测数据格式

检测数据应该是CSV格式，包含与训练数据相同的特征列（不包括标签列）。

**注意**：检测数据的列数应为40列（无标签）或41列（有标签但会被忽略）。

---

## 六、输出说明

### 训练模式输出

- **模型文件**：保存为`.pth`格式，包含：
  - 模型权重
  - 预处理参数（max_values）
  - 模型结构信息

### 检测模式输出

- **CSV结果文件**：包含以下列：
  - `预测标签`：数字标签（0=正常, 1=DoS攻击, 2=U2R攻击, 3=R2L攻击, 4=探测攻击）
  - `威胁类型`：中文威胁类型名称
  - `置信度`：预测置信度（0-1之间）

---

## 七、常见问题

### Q1: 训练时显示CUDA不可用？
A: 如果没有GPU或CUDA未正确安装，程序会自动使用CPU。可以通过 `check_gpu.py` 检查GPU配置。

### Q2: 检测时提示模型文件不存在？
A: 请确保模型文件路径正确，或先运行训练模式生成模型。

### Q3: 检测时提示数据列数不匹配？
A: 请确保检测数据的列数与训练数据格式一致（40或41列）。

### Q4: 如何提高检测准确率？
A: 可以尝试：
- 增加训练轮数（`--epochs`）
- 增加联邦学习迭代次数（`--iterations`）
- 调整学习率（`--learning_rate`）
- 使用SMOTE平衡数据（`--smote`）

---

## 八、参数调优建议

| 场景 | 推荐参数 |
|------|----------|
| 快速测试 | `--epochs 10 --iterations 3 --slices 2` |
| 标准训练 | `--epochs 20 --iterations 5 --slices 2` |
| 高质量模型 | `--epochs 30 --iterations 10 --slices 3 --smote` |
| 数据不平衡 | 添加 `--smote` 参数 |

---

## 九、查看帮助信息

```bash
python kdd_federated_learning.py --help
```

这会显示所有可用参数及其说明。

---

## 十、注意事项

1. **首次运行**：确保数据文件存在于指定路径
2. **模型保存**：训练完成后记得保存模型文件
3. **数据格式**：检测数据格式必须与训练数据一致
4. **内存使用**：大规模数据可能需要较多内存，建议使用GPU加速
5. **文件路径**：Windows系统请使用反斜杠或正斜杠均可

---

## 示例脚本（Windows）

### 训练脚本 `train.bat`
```batch
@echo off
python kdd_federated_learning.py --mode train ^
    --data_path data ^
    --model_path model.pth ^
    --epochs 20 ^
    --slices 2 ^
    --iterations 5
pause
```

### 检测脚本 `detect.bat`
```batch
@echo off
python kdd_federated_learning.py --mode detect ^
    --model_path model.pth ^
    --data_path data\KDDTest+.csv ^
    --output_path results.csv
pause
```

---

## 示例脚本（Linux/Mac）

### 训练脚本 `train.sh`
```bash
#!/bin/bash
python kdd_federated_learning.py --mode train \
    --data_path data \
    --model_path model.pth \
    --epochs 20 \
    --slices 2 \
    --iterations 5
```

### 检测脚本 `detect.sh`
```bash
#!/bin/bash
python kdd_federated_learning.py --mode detect \
    --model_path model.pth \
    --data_path data/KDDTest+.csv \
    --output_path results.csv
```

---

如有问题，请检查：
1. Python环境是否正确
2. 依赖包是否安装完整（torch, pandas, sklearn, imblearn等）
3. 数据文件是否存在且格式正确

